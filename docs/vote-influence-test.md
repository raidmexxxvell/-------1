# Тестирование влияния голосований на коэффициенты

## Цель
Проверить, что изменение BET_VOTE_INFLUENCE_MAX с 9% до 15% заметно влияет на коэффициенты после голосований пользователей.

## Тестовый сценарий

### 1. Подготовка (staging)
1. Убедиться что `BET_VOTE_INFLUENCE_MAX=0.15` установлен в render.yaml
2. Задеплоить на staging
3. Открыть вкладку "Прогнозы" и найти матч для тестирования

### 2. Базовое измерение
1. Записать исходные коэффициенты матча (П1/Х/П2)
2. Проверить количество голосов: GET `/api/vote/match-aggregates?home=Team1&away=Team2&date=2025-09-20`
3. Записать текущее распределение голосов

### 3. Создание дисбаланса голосов
Создать несколько аккаунтов и проголосовать односторонне:
```bash
# Все голоса за домашнюю команду
curl -X POST /api/vote/match \
  -d "initData=test_data" \
  -d "home=Team1" \
  -d "away=Team2" \
  -d "date=2025-09-20" \
  -d "choice=home"
```

### 4. Проверка влияния
1. Обновить страницу/перезагрузить коэффициенты
2. Сравнить новые коэффициенты с исходными
3. **Ожидаемый результат**: 
   - Коэффициент на П1 должен снизиться
   - Коэффициенты на Х и П2 должны повыситься
   - Изменение должно быть заметным (>2% при перекосе 70%+ голосов)

### 5. Математическая проверка
При голосовании 80% за домашних, 10% за ничью, 10% за гостей:
- Отклонения от нейтрального (33.33% каждый): dH=+46.67%, dD=-23.33%, dA=-23.33%
- С влиянием 15%: pH *= (1 + 0.15 * 0.4667) = pH * 1.07 (+7% к вероятности)
- Это должно снизить коэффициент на домашних примерно на 6-7%

### 6. WebSocket проверка
1. Открыть DevTools → Network → WS
2. Отследить сообщения типа `data_patch` с entity: 'odds'
3. Убедиться что новые коэффициенты приходят автоматически после голосования

### 7. Rollback план
Если влияние слишком сильное:
1. Изменить `BET_VOTE_INFLUENCE_MAX=0.10` в render.yaml
2. Redeploy
3. Повторить тест

## Критерии успеха
- ✅ Голосования заметно влияют на коэффициенты (>3% изменение при сильном перекосе)
- ✅ WebSocket обновления работают корректно
- ✅ Математика соответствует ожидаемой (15% максимального влияния)
- ✅ UI отображает обновлённые коэффициенты без багов

## Риски
- **Слишком сильное влияние**: коэффициенты становятся нереалистичными
- **Манипуляции**: возможность создания фейковых аккаунтов для влияния на коэффициенты
- **Нестабильность**: частые колебания коэффициентов могут раздражать пользователей

## Мониторинг в production
- Отслеживать жалобы на "странные" коэффициенты
- Контролировать количество голосов vs ставок (если голосов >>ставок, возможны манипуляции)
- При необходимости уменьшить влияние до 10-12%