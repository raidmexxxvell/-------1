# üìä –î–µ—Ç–∞–ª–∏ –º–∞—Ç—á–∞: –ü–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

## üéØ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–í–∫–ª–∞–¥–∫–∞ "–î–µ—Ç–∞–ª–∏ –º–∞—Ç—á–∞" ‚Äî —ç—Ç–æ —Å–ª–æ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, –≤–∫–ª—é—á–∞—é—â–∞—è:
- **–ñ–∏–≤–æ–π —Å—á–µ—Ç** —Å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
- **–°–æ–±—ã—Ç–∏—è –∏–≥—Ä–æ–∫–æ–≤** (–≥–æ–ª—ã, –ø–µ—Ä–µ–¥–∞—á–∏, –∫–∞—Ä—Ç–æ—á–∫–∏) –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **–°–æ—Å—Ç–∞–≤—ã –∫–æ–º–∞–Ω–¥** —Å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
- **WebSocket —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é** –º–µ–∂–¥—É –≤—Å–µ–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Admin UI      ‚îÇ    ‚îÇ   User UI        ‚îÇ    ‚îÇ  WebSocket      ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                  ‚îÇ    ‚îÇ  Coordinator    ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ    ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ    ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇLive Score   ‚îÇ ‚îÇ    ‚îÇ ‚îÇLive Score    ‚îÇ ‚îÇ    ‚îÇ ‚îÇws_listeners ‚îÇ ‚îÇ
‚îÇ ‚îÇControl      ‚îÇ‚óÑ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚ñ∫‚îÇDisplay       ‚îÇ‚óÑ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚ñ∫‚îÇ.ts/.js      ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ    ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ    ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ    ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ    ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇPlayer Events‚îÇ ‚îÇ    ‚îÇ ‚îÇPlayer Events ‚îÇ ‚îÇ    ‚îÇ ‚îÇrealtime-    ‚îÇ ‚îÇ
‚îÇ ‚îÇAdmin        ‚îÇ‚óÑ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚ñ∫‚îÇDisplay       ‚îÇ‚óÑ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚ñ∫‚îÇupdates.js   ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ    ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ    ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                        ‚îÇ                      ‚îÇ
         ‚ñº                        ‚ñº                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Backend API   ‚îÇ    ‚îÇ  Store Systems   ‚îÇ    ‚îÇ  Event Registry ‚îÇ
‚îÇ /api/match/     ‚îÇ    ‚îÇ                  ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ score/set       ‚îÇ    ‚îÇ MatchesStore     ‚îÇ    ‚îÇ__MatchEvents    ‚îÇ
‚îÇ /events/set     ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îº‚ñ∫MatchesStoreAPI  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îº‚ñ∫Registry        ‚îÇ
‚îÇ /rosters/get    ‚îÇ    ‚îÇ Statistics Store ‚îÇ    ‚îÇ match-events-   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ sync.js         ‚îÇ
                                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö: Live Score

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç–∞

**–§–∞–π–ª:** `static/js/profile-match-live-score.js`

```javascript
// STATE: —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å —Å–∏–≥–Ω–∞—Ç—É—Ä–æ–π –∫–∞–∫ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
const state = { 
  etag: null, 
  sig: null, // —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ —Å—á–µ—Ç–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤  
  timer: null, 
  busy: false, 
  cancelled: false,
  noFetchUntil: 0, // –≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ fetch –ø–æ—Å–ª–µ –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏–π
  lastAdminAction: 0, // timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è
  // –ö–†–ò–¢–ò–ß–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—á–µ—Ç –≤ state –¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–æ–≤ (–ø—Ä–∏–Ω—Ü–∏–ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
  currentScore: { home: 0, away: 0 }
};

// –ö–†–ò–¢–ò–ß–ù–û: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º currentScore –∏–∑ DOM –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
const initCurrentScore = () => {
  try {
    const currentText = scoreEl.textContent || '';
    const match = currentText.match(/(\d+)\s*:\s*(\d+)/);
    if (match) {
      state.currentScore.home = parseInt(match[1], 10) || 0;
      state.currentScore.away = parseInt(match[2], 10) || 0;
      console.log('[LiveScore] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å—á–µ—Ç –∏–∑ DOM:', state.currentScore.home, ':', state.currentScore.away);
    }
  } catch(e) {
    console.warn('[LiveScore] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—á–µ—Ç–∞:', e);
  }
};
```

### 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—á–µ—Ç–∞ (Anti-Race Condition)

```javascript
const applyScore=(sh,sa)=>{ 
  try { 
    if(sh==null || sa==null) {return false;}
    const newSig = generateScoreSig(sh, sa);
    
    // –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–≥–Ω–∞—Ç—É—Ä—É - –µ—Å–ª–∏ —Å—á–µ—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    if (state.sig && newSig === state.sig) {
      console.log('[LiveScore] –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ - —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å:', newSig);
      return false;
    }
    
    const newScoreText = `${Number(sh)} : ${Number(sa)}`;
    console.log('[LiveScore] –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—á–µ—Ç:', newScoreText, '—Å–∏–≥–Ω–∞—Ç—É—Ä–∞:', newSig);
    
    scoreEl.textContent = newScoreText;
    state.sig = newSig;
    
    // –ö–†–ò–¢–ò–ß–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—á–µ—Ç –≤ state –¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–æ–≤
    state.currentScore.home = Number(sh) || 0;
    state.currentScore.away = Number(sa) || 0;
    
    return true;
  } catch(_){
    return false;
  }
};
```

### 3. Admin Controls (State-Based Increments)

```javascript
// –ö–†–ò–¢–ò–ß–ù–û: –ó–∞–º–µ–Ω—è–µ–º parseScore() –Ω–∞ state-based –ø–æ–¥—Ö–æ–¥ (–ø—Ä–∏–Ω—Ü–∏–ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
const getCurrentScore = () => {
  return [state.currentScore.home, state.currentScore.away];
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∞–¥–º–∏–Ω–∞
hMinus.addEventListener('click',()=>{ const [h,a]=getCurrentScore(); postScore(Math.max(0,h-1),a); });
hPlus.addEventListener('click',()=>{ const [h,a]=getCurrentScore(); postScore(h+1,a); });
aMinus.addEventListener('click',()=>{ const [h,a]=getCurrentScore(); postScore(h,Math.max(0,a-1)); });
aPlus.addEventListener('click',()=>{ const [h,a]=getCurrentScore(); postScore(h,a+1); });
```

### 4. Server Communication & Conflict Protection

```javascript
const postScore=async(sh,sa)=>{ 
  try { 
    console.log('[LiveScore] –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å—á–µ—Ç:', sh, ':', sa);
    
    const fd=new FormData(); 
    fd.append('initData', tg?.initData||''); 
    fd.append('home',match.home||''); 
    fd.append('away',match.away||''); 
    fd.append('score_home', String(Math.max(0,sh))); 
    fd.append('score_away', String(Math.max(0,sa))); 
    
    const r=await fetch('/api/match/score/set',{ method:'POST', body:fd }); 
    const d=await r.json().catch(()=>({})); 
    
    if(!r.ok || d?.error) {
      throw new Error(d?.error||'–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    } 
    
    // –ö–†–ò–¢–ò–ß–ù–û: –õ–æ–∫–∞–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—á—ë—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª
    if (typeof d.score_home === 'number' && typeof d.score_away === 'number') {
      const applied = applyScore(d.score_home, d.score_away);
      if (applied) {
        console.log('[LiveScore] –°—á–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω —Å–µ—Ä–≤–µ—Ä–æ–º –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω:', d.score_home, ':', d.score_away);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º timestamps –¥–ª—è –∑–∞—â–∏—Ç—ã
        state.lastAdminAction = Date.now();
        state.noFetchUntil = Date.now() + 15000; // 15 —Å–µ–∫—É–Ω–¥ –∑–∞—â–∏—Ç–∞ –≤–º–µ—Å—Ç–æ 6
        
        // –ú–∞—Ä–∫–∏—Ä—É–µ–º –∞–¥–º–∏–Ω—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
        try { 
          const host=document.getElementById('ufo-match-details'); 
          if(host){ 
            host.setAttribute('data-admin-last-change-ts', String(Date.now())); 
          } 
        } catch(_){}
        
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ WebSocket-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ —Å–æ–±—ã—Ç–∏–µ
        try {
          const event = new CustomEvent('scoreUpdatedByAdmin', {
            detail: {
              home: match.home,
              away: match.away,
              score_home: d.score_home,
              score_away: d.score_away,
              timestamp: Date.now(),
              source: 'admin'
            }
          });
          document.dispatchEvent(event);
        } catch(_) {}
      }
    } else {
      console.warn('[LiveScore] –°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å—á–µ—Ç:', d);
    }
  } catch(e){ 
    console.error('[LiveScore] –û—à–∏–±–∫–∞ postScore:', e);
    window.showAlert?.(e?.message||'–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—á—ë—Ç','error'); 
  } 
};
```

---

## ‚öΩ –°–æ–±—ã—Ç–∏—è –∏–≥—Ä–æ–∫–æ–≤: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Admin ‚Üí Users

### 1. Admin Event Management

**–§–∞–π–ª:** `static/js/profile-match-roster-events.js`

```javascript
// Admin –∏–∑–º–µ–Ω—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ (–≥–æ–ª—ã, –ø–µ—Ä–µ–¥–∞—á–∏, –∫–∞—Ä—Ç–æ—á–∫–∏)
sel.addEventListener('change', async () => {
  const desired = parseInt(sel.value, 10) || 0;
  const current = getCount(key, type);
  if (desired === current) { return; }
  const pendKey = `${(match.home||'').toLowerCase()}__${(match.away||'').toLowerCase()}__${side}:${(player||'').toLowerCase()}:${type}`;
  if (window.__adminEventPending.has(pendKey)) { return; }
  window.__adminEventPending.add(pendKey);
  sel.disabled = true;
  try {
    await applyDelta(desired - current);
    
    // –ö–†–ò–¢–ò–ß–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    if(!evIdx.has(key)) {evIdx.set(key,{goal:0,assist:0,yellow:0,red:0});}
    evIdx.get(key)[type]= desired;
    icon.style.opacity= desired>0? '1':'0.25';
    highlightRow(trRef,key);
    
    // –£–≤–µ–¥–æ–º–ª—è–µ–º –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ (–∫–∞–∫ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ)
    try {
      const eventUpdate = new CustomEvent('playerEventUpdated', {
        detail: {
          home: match.home,
          away: match.away,
          team: side,
          player: player,
          eventType: type,
          count: desired,
          timestamp: Date.now(),
          source: 'admin'
        }
      });
      document.dispatchEvent(eventUpdate);
    } catch(_) {}
    
  } catch(err) {
    console.error('[MatchRostersEvents] –û—à–∏–±–∫–∞ applyDelta:', err);
    sel.value = String(current); // –æ—Ç–∫–∞—Ç
    window.showAlert?.('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è','error');
  } finally {
    window.__adminEventPending.delete(pendKey);
    sel.disabled = false;
  }
});
```

### 2. WebSocket Event Distribution

**–§–∞–π–ª:** `static/js/realtime-updates.js`

```javascript
case 'match_events':
  // –ù–û–í–û–ï: –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –º–∞—Ç—á–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  try {
    console.log('[–†–µ–∞–ª—Ç–∞–π–º] –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –º–∞—Ç—á–∞:', data);
    if (data && data.home && data.away) {
      // –ö–†–ò–¢–ò–ß–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à —Å–æ–±—ã—Ç–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      if (window.__MatchEventsRegistry && data.events) {
        window.__MatchEventsRegistry.updateEventsCache(data.home, data.away, data.events);
      }
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–¥–∏–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
      const event = new CustomEvent('eventsRegistryUpdate', { 
        detail: { 
          home: data.home, 
          away: data.away, 
          type: 'match_events',
          reason: data.reason,
          timestamp: Date.now(),
          events: data.events || {}
        } 
      });
      document.dispatchEvent(event);
```

### 3. User Event Synchronization

```javascript
// Listener –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–æ–±—ã—Ç–∏–π –∏–≥—Ä–æ–∫–æ–≤ –æ—Ç –∞–¥–º–∏–Ω–∞ (–∫–∞–∫ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ)
document.addEventListener('playerEventUpdated', (event) => {
  try {
    const { home, away, team, player, eventType, count, source } = event.detail;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π –º–∞—Ç—á
    const currentMatch = window.__currentMatchDetails;
    if (!currentMatch || currentMatch.home !== home || currentMatch.away !== away) {
      return;
    }
    
    console.log('[MatchRostersEvents] –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∏–≥—Ä–æ–∫–∞:', player, eventType, count);
    
    // –ù–∞—Ö–æ–¥–∏–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    document.querySelectorAll(`select[data-match-home="${home}"][data-match-away="${away}"][data-team="${team}"][data-player="${player}"][data-event-type="${eventType}"]`).forEach(select => {
      try {
        const currentValue = parseInt(select.value, 10) || 0;
        if (currentValue !== count) {
          select.value = String(count);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
          const icon = select.parentNode?.querySelector('img');
          if (icon) {
            icon.style.opacity = count > 0 ? '1' : '0.25';
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å—Ç—Ä–æ–∫–∏
          const row = select.closest('tr');
          if (row) {
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            const playerKey = player.toLowerCase().trim();
            const playerSelects = row.querySelectorAll('select');
            let hasAnyEvents = false;
            
            playerSelects.forEach(s => {
              const val = parseInt(s.value, 10) || 0;
              if (val > 0) hasAnyEvents = true;
            });
            
            row.style.backgroundColor = hasAnyEvents ? 'rgba(255,255,255,0.06)' : '';
          }
          
          console.log('[MatchRostersEvents] –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —ç–ª–µ–º–µ–Ω—Ç –∏–≥—Ä–æ–∫–∞:', player, eventType, '‚Üí', count);
        }
      } catch(err) {
        console.warn('[MatchRostersEvents] –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞:', err);
      }
    });
    
  } catch(error) {
    console.error('[MatchRostersEvents] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ playerEventUpdated:', error);
  }
});
```

---

## üè™ Store Systems: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### 1. MatchEventsRegistry (–ö—ç—à —Å–æ–±—ã—Ç–∏–π)

**–§–∞–π–ª:** `static/js/match-events-sync.js`

```javascript
// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä —Å–æ–±—ã—Ç–∏–π –º–∞—Ç—á–µ–π
window.__MatchEventsRegistry = {
  eventsCache: new Map(),
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞ –º–∞—Ç—á–∞ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
  getMatchKey(home, away) {
    const h = (home || '').toLowerCase().trim();
    const a = (away || '').toLowerCase().trim();
    return `${h}__${a}`;
  },
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ —Å–æ–±—ã—Ç–∏–π
  updateEventsCache(home, away, events) {
    const key = this.getMatchKey(home, away);
    this.eventsCache.set(key, events);
    console.log('[EventsRegistry] –û–±–Ω–æ–≤–ª–µ–Ω –∫—ç—à —Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–∞—Ç—á–∞:', key, events);
  },
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –∏–∑ –∫—ç—à–∞
  getEvents(home, away) {
    const key = this.getMatchKey(home, away);
    return this.eventsCache.get(key) || { home: [], away: [] };
  }
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ WebSocket –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å–æ–±—ã—Ç–∏–π
function handleEventUpdate(data) {
  try {
    if (!data || !data.home || !data.away) return;
    
    console.log('[EventsRegistry] –ü–æ–ª—É—á–µ–Ω–æ WebSocket –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π:', data);
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –≤ payload - –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
    if (data.events) {
      updateEventsCache(data.home, data.away, data.events);
    }
    
    // –£–≤–µ–¥–æ–º–ª—è–µ–º UI –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const event = new CustomEvent('eventsRegistryUpdate', {
      detail: {
        home: data.home,
        away: data.away,
        type: data.entity,
        reason: data.reason,
        timestamp: Date.now()
      }
    });
    document.dispatchEvent(event);
  } catch(e) {
    console.error('[EventsRegistry] –û—à–∏–±–∫–∞ handleEventUpdate:', e);
  }
}
```

### 2. Store-Driven vs Admin Rendering (Bridge Pattern)

**–§–∞–π–ª:** `static/js/store/match_legacy_bridge.js`

```javascript
// –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º, –æ—Å—Ç–∞–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —Å –∫–æ–Ω—Ç—Ä–æ–ª–∞–º–∏
try {
  const adminId = document.body.getAttribute('data-admin');
  const isAdmin = !!(adminId && adminId.trim() !== '');
  if (isAdmin) {
    console.log('[Bridge] Admin mode detected, using original rosters render');
    return orig.call(this, match, details, mdPane, els);
  }
} catch (_) {}

// –ï—Å–ª–∏ –≤–µ–±—Å–æ–∫–µ—Ç—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
try {
  if (!window.__WEBSOCKETS_ENABLED__) {
    console.log('[Bridge] WebSockets disabled, using original rosters render');
    return orig.call(this, match, details, mdPane, els);
  }
} catch (_) {}

// –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: Store-driven —Ä–µ–Ω–¥–µ—Ä —Å –ø–æ–¥–ø–∏—Å–∫–æ–π –Ω–∞ —Å–æ–±—ã—Ç–∏—è
// –ö–†–ò–¢–ò–ß–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø—Ä–∏–Ω—Ü–∏–ø —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
function setupEventsUpdateListener() {
  // –ò–∑–±–µ–≥–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
  if (window.__storeEventsListenerInstalled) return;
  window.__storeEventsListenerInstalled = true;
  
  document.addEventListener('eventsRegistryUpdate', (event) => {
    try {
      const { home, away, events } = event.detail;
      if (!home || !away) return;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç—ã –ª–∏ –¥–µ—Ç–∞–ª–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–∞—Ç—á–∞
      const matchDetailsPane = document.getElementById('ufo-match-details');
      if (!matchDetailsPane || matchDetailsPane.style.display === 'none') return;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ —Ç–æ—Ç –∂–µ –º–∞—Ç—á
      const currentMatch = window.__currentMatchDetails;
      if (!currentMatch || currentMatch.home !== home || currentMatch.away !== away) return;
      
      console.log('[Bridge] –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è store-driven —Ä–µ–Ω–¥–µ—Ä–∞:', home, 'vs', away);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à —Å–æ–±—ã—Ç–∏–π –≤ –ø–∞–Ω–µ
      if (events) {
        matchDetailsPane.__lastEvents = events;
      }
      
      // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ store-driven –ª–æ–≥–∏–∫—É
      try {
        if (window.MatchRostersEvents && !isAdminMode()) {
          const els = extractElements(matchDetailsPane);
          if (els.homePane && els.awayPane) {
            renderRostersFromStore(currentMatch, matchDetailsPane, els);
            console.log('[Bridge] Store-driven –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
          }
        }
      } catch(renderError) {
        console.warn('[Bridge] –û—à–∏–±–∫–∞ store-driven –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞:', renderError);
      }
      
    } catch(error) {
      console.error('[Bridge] –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ eventsRegistryUpdate –≤ store-driven:', error);
    }
  });
  
  console.log('[Bridge] Events update listener —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è store-driven —Ä–µ–Ω–¥–µ—Ä–∞');
}
```

---

## üì° WebSocket Coordination Layer

### 1. Central Event Processing

**–§–∞–π–ª:** `static/js/store/ws_listeners.ts` (–∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –≤ `.js`)

```typescript
// Data patch events - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å __MatchEventsRegistry (—Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫)
window.addEventListener('ws:data_patch', (e: any) => {
  try {
    const patch = e.detail || {};
    console.log('[WS Listeners] Processing data_patch:', patch);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ç—á–µ–π –º–∞—Ç—á–µ–π
    if (patch.entity === 'match' && patch.id?.home && patch.id?.away) {
      const { home, away } = patch.id;
      const fields = patch.fields || {};
      
      // –ö–†–ò–¢–ò–ß–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º __MatchEventsRegistry –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–±—ã—Ç–∏—è
      if ((fields.events || fields.rosters) && (window as any).__MatchEventsRegistry) {
        try {
          const registry = (window as any).__MatchEventsRegistry;
          if (fields.events) {
            console.log('[WS Listeners] Updating MatchEventsRegistry cache:', fields.events);
            registry.updateEventsCache(home, away, fields.events);
          }
        } catch (e) {
          console.warn('[WS Listeners] Failed to update MatchEventsRegistry:', e);
        }
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç –ë–ï–ó –ú–ï–†–¶–ê–ù–ò–Ø (–ø—Ä–∏–Ω—Ü–∏–ø –∏–∑ —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –∫–æ–º–º–∏—Ç–∞)
      if (fields.score_home !== undefined || fields.score_away !== undefined) {
        try {
          const sh = fields.score_home;
          const sa = fields.score_away;
          if (typeof sh === 'number' && typeof sa === 'number') {
            console.log('[WS Listeners] –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç —á–µ—Ä–µ–∑ WebSocket:', sh, ':', sa);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –≤—Å–µ—Ö score –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            const scoreEvent = new CustomEvent('matchScoreUpdate', {
              detail: {
                home,
                away,
                score_home: sh,
                score_away: sa,
                timestamp: Date.now(),
                source: 'websocket'
              }
            });
            document.dispatchEvent(scoreEvent);
          }
        } catch (e) {
          console.warn('[WS Listeners] Failed to process score update:', e);
        }
      }
    }
  } catch (e) {
    console.warn('[WS Listeners] Failed to process data_patch:', e);
  }
});
```

### 2. TypeScript Integration with Vanilla JS

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥**:
- **–ù–æ–≤—ã–π –∫–æ–¥**: TypeScript + Nano Stores
- **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥**: Vanilla JS (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- **–ö–æ–º–ø–∏–ª—è—Ü–∏—è**: `.ts` ‚Üí `.js` –¥–ª—è production

```json
// tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext", 
    "moduleResolution": "node",
    "strict": true,
    "noImplicitAny": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "outDir": "./static/js/dist",
    "rootDir": "./static/js"
  },
  "include": ["static/js/**/*.ts"]
}
```

---

## üîÑ Polling vs WebSocket Coordination

### 1. Smart Polling (Fallback Mode)

```javascript
// –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è WebSocket –∫–∞–∫ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
const syncPolling = () => {
  try {
    const needPoll = !isWsActive();
    console.log('[LiveScore] –ü—Ä–æ–≤–µ—Ä–∫–∞ polling:', needPoll ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω');
    
    if (needPoll) {
      if (!state.timer) { 
        console.log('[LiveScore] –ó–∞–ø—É—Å–∫–∞–µ–º polling');
        fetchScore(); // –ø–µ—Ä–≤–∏—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        schedule(); 
      }
    } else {
      if (state.timer) { 
        console.log('[LiveScore] –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º polling - WebSocket –∞–∫—Ç–∏–≤–µ–Ω');
        clearTimeout(state.timer); 
        state.timer = null; 
      }
    }
  } catch(e) {
    console.error('[LiveScore] –û—à–∏–±–∫–∞ syncPolling:', e);
  }
};
```

### 2. WebSocket Status Detection

```javascript
const isWsActive = ()=>{
  try {
    if(!window.__WEBSOCKETS_ENABLED__) {return false;}
    if(!__wsTopic) {return false;}
    const ru = window.realtimeUpdater;
    return !!(ru && typeof ru.getTopicEnabled==='function' && ru.getTopicEnabled() && typeof ru.hasTopic==='function' && ru.hasTopic(__wsTopic));
  } catch(_) { return false; }
};
```

---

## üõ°Ô∏è Conflict Resolution & Race Condition Protection

### 1. Admin Conflict Protection (15-second Window)

```javascript
// –ó–∞—â–∏—Ç–∞: –Ω–µ –ø–µ—Ä–µ—Ç–∏—Ä–∞—Ç—å –∞–¥–º–∏–Ω—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∫–∞–∫ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ - –±–æ–ª—å—à–∏–π –ø–µ—Ä–∏–æ–¥)
if (Date.now() < state.noFetchUntil) { 
  console.log('[LiveScore] –ü—Ä–æ–ø—É—Å–∫–∞–µ–º fetch - –∑–∞—â–∏—Ç–∞ –æ—Ç –∞–¥–º–∏–Ω-–∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞');
  return; 
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —Å–ª–∏—à–∫–æ–º –ª–∏ —á–∞—Å—Ç—ã–µ –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è
const timeSinceAdmin = Date.now() - state.lastAdminAction;
if (timeSinceAdmin < 10000) { // 10 —Å–µ–∫—É–Ω–¥ –∑–∞—â–∏—Ç–∞ –≤–º–µ—Å—Ç–æ 6
  console.log('[LiveScore] –ü—Ä–æ–ø—É—Å–∫–∞–µ–º fetch - –Ω–µ–¥–∞–≤–Ω–µ–µ –∞–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏–µ');
  return;
}
```

### 2. Signature-Based Deduplication

```javascript
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–≥–Ω–∞—Ç—É—Ä—ã —Å—á–µ—Ç–∞ (–∫–∞–∫ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ)
const generateScoreSig = (sh, sa) => {
  try {
    return `${Number(sh)||0}:${Number(sa)||0}`;
  } catch(_) {
    return '0:0';
  }
};

// –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–≥–Ω–∞—Ç—É—Ä—É - –µ—Å–ª–∏ —Å—á–µ—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
if (state.sig && newSig === state.sig) {
  console.log('[LiveScore] –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ - —Å–∏–≥–Ω–∞—Ç—É—Ä–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å:', newSig);
  return false;
}
```

### 3. ETag-Based HTTP Caching

```javascript
// –ò—Å–ø–æ–ª—å–∑—É–µ–º ETag –∫–∞–∫ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ
const headers = state.etag ? { 'If-None-Match': state.etag } : {};
const r = await fetch(url, { headers }); 

if (r.status === 304) {
  console.log('[LiveScore] 304 Not Modified - —Å—á–µ—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è');
  return;
}

const d = await r.json(); 
const newEtag = r.headers.get('ETag');

if (typeof d?.score_home==='number' && typeof d?.score_away==='number') {
  const applied = applyScore(d.score_home, d.score_away);
  if (applied) {
    state.etag = newEtag;
    console.log('[LiveScore] –°—á–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω –∏–∑ API:', d.score_home, ':', d.score_away);
  }
}
```

---

## üìä Performance Metrics & Monitoring

### 1. Network Optimization
- **ETag caching**: –£–º–µ–Ω—å—à–∞–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ 60-80% –¥–ª—è –Ω–µ–∏–∑–º–µ–Ω–∏–≤—à–∏—Ö—Å—è –¥–∞–Ω–Ω—ã—Ö
- **WebSocket coordination**: –û—Ç–∫–ª—é—á–∞–µ—Ç polling –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º WS
- **Debounced updates**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∞–º-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI

### 2. Memory Management
- **Event cleanup**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–Ω—è—Ç–∏–µ listeners –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∞
- **Cache rotation**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ `__MatchEventsRegistry`
- **DOM optimization**: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ —Å DOM

### 3. User Experience
- **Sub-second latency**: –°–æ–±—ã—Ç–∏—è –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ WebSocket
- **Conflict resolution**: –ê–¥–º–∏–Ω-–¥–µ–π—Å—Ç–≤–∏—è –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
- **Visual feedback**: –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è UI –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üîß API Endpoints

### Score Management
```
POST /api/match/score/set
GET  /api/match/score/get
POST /api/match/status/set-live
GET  /api/match/status/get
```

### Player Events
```
POST /api/match/events/set
GET  /api/match/events/get
```

### Rosters & Statistics
```
GET  /api/match/rosters/get
GET  /api/match/stats/get
```

---

## üéØ Key Architectural Decisions

### 1. **State-Based vs DOM-Based**
‚ùå **Before**: `parseScore()` —á–∏—Ç–∞–ª –∏–∑ DOM ‚Üí race conditions  
‚úÖ **After**: `state.currentScore` ‚Üí –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫

### 2. **Unified Event System** 
‚ùå **Before**: –†–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
‚úÖ **After**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (`matchScoreUpdate`, `playerEventUpdated`, `eventsRegistryUpdate`)

### 3. **Hybrid Admin/User Rendering**
‚ùå **Before**: –û–¥–∏–Ω —Ä–µ–Ω–¥–µ—Ä –¥–ª—è –≤—Å–µ—Ö ‚Üí –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã  
‚úÖ **After**: Admin = original render, Users = store-driven + reactive subscriptions

### 4. **TypeScript Integration**
‚ùå **Before**: –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —Ä–∞–∑—Ä—É—à–∏–ª–∞ –±—ã existing –∫–æ–¥  
‚úÖ **After**: –ù–æ–≤—ã–µ –º–æ–¥—É–ª–∏ –Ω–∞ TS, legacy JS –æ—Å—Ç–∞–µ—Ç—Å—è, –∫–æ–º–ø–∏–ª—è—Ü–∏—è –≤ production

---

## üöÄ Future Evolution (Roadmap Stage 6+)

### Planned Improvements:
1. **Full TypeScript Migration**: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ legacy JS
2. **Nano Stores Integration**: –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è  
3. **Webpack/Vite Bundling**: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
4. **Service Worker**: Offline support
5. **WebRTC**: P2P sync –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

### Performance Targets:
- **Load Time**: < 200ms initial render
- **Update Latency**: < 50ms for score changes
- **Memory Usage**: < 10MB for full match details
- **Network**: < 1KB/minute background traffic

---

## üìù Troubleshooting

### Common Issues:

1. **Score Reset (0-1 ‚Üí 1-0)**  
   ‚úÖ **Fixed**: State-based increments –≤–º–µ—Å—Ç–æ DOM parsing

2. **Events Not Syncing**  
   ‚úÖ **Fixed**: Store-driven render + reactive subscriptions

3. **Race Conditions**  
   ‚úÖ **Fixed**: Signature system + admin conflict protection

4. **Memory Leaks**  
   ‚úÖ **Fixed**: Proper event cleanup –≤ mdPane.__scoreSetupCancel

### Debug Tools:
```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
console.log('Score State:', window.MatchLiveScore?.state);
console.log('Events Registry:', window.__MatchEventsRegistry?.eventsCache);
console.log('WebSocket Active:', window.realtimeUpdater?.getTopicEnabled());
```

---

*–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞: 22 —Å–µ–Ω—Ç—è–±—Ä—è 2025 –≥.*  
*–í–µ—Ä—Å–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã: Statistics-Based Pattern v2.0*