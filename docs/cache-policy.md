# Политика кэширования: Лига Обнинска

## Схема кэш-ключей

Все кэш-ключи следуют принципу `категория:тип[:дополнительные_параметры]`

### 1. League (Лига) — TTL: 5-30 сек
- `league:table` — таблица лиги (5 сек, быстрые обновления)
- `league:schedule` — расписание матчей (8 сек)
- `league:stats` — статистика лиги (30 сек)
- `league:results` — результаты матчей (15 сек)

### 2. Match Details (Детали матчей) — TTL: 10 мин/реалтайм
- `md:{home}::{away}` — основные детали матча (10 мин)
- `md:etag-temp:{home}::{away}` — временные ETag записи
- `md:stats:{home}::{away}` — статистика матча (реалтайм)

### 3. Predictions (Прогнозы) — TTL: 2-5 мин
- `predictions:list` — список доступных прогнозов (5 мин)
- `predictions:user:{user_id}` — прогнозы пользователя (2 мин)

### 4. Leaderboard (Лидерборды) — TTL: 1 мин
- `lb:predictors` — топ прогнозистов (1 мин)
- `lb:rich` — топ богатых игроков (1 мин) 
- `lb:server` — серверные лидеры (1 мин)
- `lb:prizes` — призы и награды (30 сек)

### 5. Achievements (Достижения) — TTL: 30 мин
- `achievements:v1` — пользовательские достижения (30 мин)

### 6. Ads & Features (Реклама/Фичи) — TTL: 5-15 мин
- `ads:topmatch` — топ матч для рекламы (15 мин)

### 7. Database API — TTL: varies
- `GET:{endpoint}` — общий паттерн для database-client.js

## Стратегии инвалидации

### Automatic (Автоматическая)
- По TTL срока давности
- При получении 304 Not Modified — продление кэша

### Event-driven (По событиям)
- WS события `data_patch` → инвалидация соответствующих ключей
- `match_results_update` → `league:table`, `league:stats`
- `schedule_update` → `league:schedule`
- `odds_update` → `predictions:*`

### Manual (Ручная)
- Админ-действия → сброс связанных кэшей
- Force refresh в UI → `forceRevalidate: true`

## TTL по приоритету обновлений

### Критически важные (реалтайм) — 5-30 сек
- Счет матчей, таблица лиги, коэффициенты

### Важные (частые обновления) — 1-5 мин
- Прогнозы, лидерборды, статистика

### Стабильные (редкие обновления) — 10-30 мин
- Достижения, детали пользователя, настройки

## Правила версионирования

### ETag-based
- Сервер возвращает ETag в заголовках
- Клиент отправляет `If-None-Match`
- 304 → использовать кэш, обновить TTL

### Version-based (для WS патчей)
- Каждый odds патч содержит `version`
- Применяется только если `version > current`
- Предотвращает гонки версий

## Мониторинг кэша

### Метрики в debug режиме
- Cache hit/miss ratio по категориям
- Частота инвалидации
- Средний размер кэшированных данных

### Проблемные сценарии
- Слишком частые запросы одного ключа
- Большие объемы данных в кэше
- Долгие TTL при частых изменениях

## Конфигурация по окружениям

### Development
- Короткие TTL для быстрого тестирования
- Подробное логирование кэш-операций

### Production
- Оптимальные TTL для баланса нагрузки/свежести
- Ошибки кэша не должны блокировать UI